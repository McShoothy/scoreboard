{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Registrations{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-person-plus me-2"></i>{{ tournament.name }}</h1>
        <p class="text-muted mb-0">Team Registration Management</p>
    </div>
    <div>
        <a href="{{ url_for('admin.view_tournament', tournament_id=tournament.id) }}"
            class="btn btn-outline-light me-2">
            <i class="bi bi-trophy me-1"></i>View Tournament
        </a>
        <a href="{{ url_for('admin.manage_tournaments') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Registration Info Card -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Registration Info</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted small">Registration Code</label>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg text-center font-monospace"
                            value="{{ tournament.registration_code }}" readonly id="reg-code">
                        <button class="btn btn-outline-warning" onclick="copyCode()" title="Copy code">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-warning" onclick="showQRCode()" title="Show QR Code">
                            <i class="bi bi-qr-code"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted small">Direct Registration URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control small"
                            value="{{ url_for('register.register_tournament', code=tournament.registration_code, _external=True) }}"
                            readonly id="reg-url">
                        <button class="btn btn-outline-warning" onclick="copyUrl()" title="Copy URL">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <small class="text-muted">Teams can scan QR or visit this URL to sign up directly</small>
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted small">Status</label>
                    <div>
                        {% if tournament.registration_open %}
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-door-open me-1"></i>Registration Open
                        </span>
                        {% else %}
                        <span class="badge bg-danger fs-6">
                            <i class="bi bi-door-closed me-1"></i>Registration Closed
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted small">Teams</label>
                    <div class="d-flex gap-3">
                        <div>
                            <span class="fs-4 fw-bold text-warning">{{ teams|length }}</span>
                            <span class="text-muted"> / {{ tournament.max_teams }}</span>
                        </div>
                        {% if tournament.require_confirmation %}
                        <div>
                            <span class="badge bg-info">
                                {{ teams|selectattr('is_confirmed')|list|length }} confirmed
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <div class="d-grid gap-2">
                    <button class="btn {% if tournament.registration_open %}btn-danger{% else %}btn-success{% endif %}"
                        onclick="toggleRegistration()">
                        {% if tournament.registration_open %}
                        <i class="bi bi-door-closed me-1"></i>Close Registration
                        {% else %}
                        <i class="bi bi-door-open me-1"></i>Open Registration
                        {% endif %}
                    </button>

                    <button class="btn btn-outline-warning" onclick="regenerateCode()">
                        <i class="bi bi-shuffle me-1"></i>Generate New Code
                    </button>

                    {% if teams|selectattr('is_confirmed')|list|length >= tournament.min_teams %}
                    <button class="btn btn-ru" onclick="startTournament()">
                        <i class="bi bi-play-fill me-1"></i>Start Tournament
                    </button>
                    {% else %}
                    <button class="btn btn-secondary" disabled>
                        <i class="bi bi-play-fill me-1"></i>Need {{ tournament.min_teams }} teams
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Settings</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i
                            class="bi {% if tournament.require_confirmation %}bi-check-circle text-success{% else %}bi-x-circle text-muted{% endif %} me-2"></i>
                        Admin confirmation required
                    </li>
                    <li class="mb-2">
                        <i
                            class="bi {% if tournament.require_email %}bi-check-circle text-success{% else %}bi-x-circle text-muted{% endif %} me-2"></i>
                        Email required
                    </li>
                    <li>
                        <i class="bi bi-people me-2 text-warning"></i>
                        {{ tournament.min_teams }} - {{ tournament.max_teams }} teams
                    </li>
                </ul>
            </div>
        </div>

        <!-- Add Team Manually Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Team Manually</h5>
            </div>
            <div class="card-body">
                <form id="add-team-form">
                    <div class="mb-3">
                        <label class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="add-team-name" required maxlength="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Player 1</label>
                        <input type="text" class="form-control" id="add-player1" required maxlength="30">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Player 2</label>
                        <input type="text" class="form-control" id="add-player2" required maxlength="30">
                    </div>
                    <button type="submit" class="btn btn-ru w-100">
                        <i class="bi bi-plus-circle me-1"></i>Add Team
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Teams List -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Registered Teams</h5>
                <span class="badge bg-warning text-dark">{{ teams|length }} teams</span>
            </div>
            <div class="card-body">
                {% if teams %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Team Name</th>
                                <th>Players</th>
                                {% if tournament.require_email %}
                                <th>Email</th>
                                {% endif %}
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in teams %}
                            <tr id="team-row-{{ team.id }}">
                                <td>{{ loop.index }}</td>
                                <td class="fw-bold">{{ team.name }}</td>
                                <td>
                                    <small>{{ team.player1 }} & {{ team.player2 }}</small>
                                </td>
                                {% if tournament.require_email %}
                                <td><small class="text-muted">{{ team.email or '-' }}</small></td>
                                {% endif %}
                                <td>
                                    {% if team.is_confirmed %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Confirmed
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock me-1"></i>Pending
                                    </span>
                                    {% endif %}
                                    {% if team.is_checked_in %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-person-check me-1"></i>Checked In
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if not team.is_confirmed %}
                                        <button class="btn btn-success" onclick="confirmTeam({{ team.id }})"
                                            title="Confirm">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        {% endif %}
                                        <button
                                            class="btn btn-{% if team.is_checked_in %}warning{% else %}outline-info{% endif %}"
                                            onclick="checkInTeam({{ team.id }})" title="Toggle Check-in">
                                            <i class="bi bi-person-check"></i>
                                        </button>
                                        <button class="btn btn-outline-danger"
                                            onclick="rejectTeam({{ team.id }}, '{{ team.name }}')" title="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">No teams registered yet.</p>
                    <p class="text-muted">Share the registration code: <strong class="text-warning">{{
                            tournament.registration_code }}</strong></p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-warning">
                <h5 class="modal-title" id="qrModalLabel">
                    <i class="bi bi-qr-code me-2"></i>Scan to Register
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="text-muted mb-3">Teams can scan this QR code to register directly</p>
                <div class="bg-white p-4 rounded d-inline-block">
                    <img id="qr-code-img" src="" alt="Registration QR Code" style="width: 250px; height: 250px;">
                </div>
                <p class="mt-3">
                    <span class="badge bg-warning text-dark fs-5 font-monospace">{{ tournament.registration_code
                        }}</span>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const tournamentId = {{ tournament.id }};
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Socket.IO for real-time updates
    const socket = io();

    socket.on('team_registered', function (data) {
        if (data.tournament_id === tournamentId) {
            location.reload();
        }
    });

    socket.on('team_confirmed', function (data) {
        if (data.tournament_id === tournamentId) {
            location.reload();
        }
    });

    socket.on('team_removed', function (data) {
        if (data.tournament_id === tournamentId) {
            const row = document.getElementById('team-row-' + data.team_id);
            if (row) row.remove();
        }
    });

    function copyCode() {
        navigator.clipboard.writeText(document.getElementById('reg-code').value);
        alert('Code copied!');
    }

    function copyUrl() {
        const url = document.getElementById('reg-url').value;
        navigator.clipboard.writeText(url);
        alert('URL copied!');
    }

    function showQRCode() {
        const regUrl = document.getElementById('reg-url').value;
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(regUrl)}`;
        document.getElementById('qr-code-img').src = qrApiUrl;
        new bootstrap.Modal(document.getElementById('qrModal')).show();
    }

    function toggleRegistration() {
        fetch(`/admin/tournament/${tournamentId}/registration/toggle`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    function regenerateCode() {
        if (confirm('Generate a new registration code? The old code will no longer work.')) {
            fetch(`/admin/tournament/${tournamentId}/regenerate-code`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('reg-code').value = data.code;
                        alert('New code: ' + data.code);
                    }
                });
        }
    }

    function confirmTeam(teamId) {
        fetch(`/admin/tournament/${tournamentId}/team/${teamId}/confirm`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    function checkInTeam(teamId) {
        fetch(`/admin/tournament/${tournamentId}/team/${teamId}/checkin`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    function rejectTeam(teamId, teamName) {
        if (confirm(`Remove team "${teamName}"? This cannot be undone.`)) {
            fetch(`/admin/tournament/${tournamentId}/team/${teamId}/reject`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const row = document.getElementById('team-row-' + teamId);
                        if (row) row.remove();
                    }
                });
        }
    }

    function startTournament() {
        if (confirm('Start the tournament? This will close registration and prepare the bracket.')) {
            fetch(`/admin/tournament/${tournamentId}/start`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = `/admin/tournaments/${tournamentId}`;
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }
    }

    // Handle manual team addition form
    document.getElementById('add-team-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const teamName = document.getElementById('add-team-name').value.trim();
        const player1 = document.getElementById('add-player1').value.trim();
        const player2 = document.getElementById('add-player2').value.trim();

        if (!teamName || !player1 || !player2) {
            alert('All fields are required');
            return;
        }

        fetch(`/admin/tournament/${tournamentId}/team/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: teamName,
                player1: player1,
                player2: player2
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => {
                alert('Error adding team');
                console.error(err);
            });
    });
</script>
{% endblock %}