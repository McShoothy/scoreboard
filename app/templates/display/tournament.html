{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Bracket{% endblock %}

{% block navbar %}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bracket-bg: #14141f;
        --card-bg: #1c1c2a;
        --card-border: #3a3a50;
        --accent: #ff6b00;
        --winner-green: #51cf66;
    }
    
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        height: 100%;
        overflow: hidden;
        background-color: var(--bracket-bg);
    }
    
    /* Override base.html container */
    main.container {
        max-width: 100% !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Animated background grid */
    .bracket-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(rgba(255, 107, 0, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 107, 0, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        animation: gridPulse 4s ease-in-out infinite;
        z-index: 0;
    }
    
    @keyframes gridPulse {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }
    
    /* Viewport container for scaling */
    .bracket-viewport {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        z-index: 1;
    }
    
    /* Header bar - compact */
    .bracket-header {
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--card-bg), #252538);
        padding: 0.4rem 1rem;
        border-bottom: 2px solid var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }
    
    .bracket-header h1 {
        font-size: 1.2rem;
        margin: 0;
        text-shadow: 0 0 20px rgba(255, 107, 0, 0.3);
    }
    
    .tournament-progress {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .progress-bar-container {
        width: 150px;
        height: 6px;
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--winner-green));
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .progress-text {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
    }
    
    /* Scalable bracket area - full bleed */
    .bracket-scale-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 0.5rem;
    }
    
    .bracket-container {
        display: flex;
        gap: 2rem;
        transform-origin: center center;
        transition: transform 0.3s ease;
        position: relative;
    }
    
    /* SVG connectors */
    .bracket-connectors {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
    }
    
    .connector-line {
        stroke: var(--card-border);
        stroke-width: 2;
        fill: none;
        transition: stroke 0.3s ease;
    }
    
    .connector-line.active {
        stroke: var(--accent);
        stroke-width: 3;
        filter: drop-shadow(0 0 4px var(--accent));
    }
    
    /* Round columns */
    .round-column {
        min-width: 260px;
        display: flex;
        flex-direction: column;
        z-index: 1;
    }
    
    .round-header {
        background: linear-gradient(135deg, var(--accent), #ff8533);
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
    }
    
    .round-header.finals {
        background: linear-gradient(135deg, #ffd700, #ffaa00);
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
        animation: finalsGlow 2s ease-in-out infinite;
    }
    
    @keyframes finalsGlow {
        0%, 100% { box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); }
        50% { box-shadow: 0 4px 30px rgba(255, 215, 0, 0.7); }
    }
    
    .matches-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        gap: 0.5rem;
    }
    
    /* Match cards */
    .match-card {
        background: var(--card-bg);
        border: 2px solid var(--card-border);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .match-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }
    
    .match-card.current {
        border-color: var(--accent);
        box-shadow: 0 0 30px rgba(255, 107, 0, 0.4);
        animation: currentPulse 2s ease-in-out infinite;
    }
    
    @keyframes currentPulse {
        0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 0, 0.3); }
        50% { box-shadow: 0 0 40px rgba(255, 107, 0, 0.6); }
    }
    
    .match-card.completed {
        opacity: 0.7;
    }
    
    .match-card.completed:hover {
        opacity: 1;
    }
    
    .live-badge {
        background: linear-gradient(90deg, var(--accent), #ff4444);
        color: white;
        text-align: center;
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
        animation: livePulse 1.5s ease-in-out infinite;
    }
    
    @keyframes livePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .team-row {
        padding: 0.6rem 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .team-row:first-of-type {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .team-row.winner {
        background: linear-gradient(90deg, rgba(81, 207, 102, 0.2), transparent);
    }
    
    .team-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }
    
    .team-name .trophy {
        color: #ffd700;
        animation: trophyBounce 1s ease-in-out infinite;
    }
    
    @keyframes trophyBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }
    
    .team-row .score {
        font-size: 1.4rem;
        font-weight: bold;
        min-width: 40px;
        text-align: right;
    }
    
    .team-row.winner .score {
        color: var(--winner-green);
        text-shadow: 0 0 10px var(--winner-green);
    }
    
    .tbd {
        color: rgba(255,255,255,0.4);
        font-style: italic;
    }
    
    /* Winner celebration for finals */
    .match-card.champion {
        border-color: #ffd700;
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
        animation: championGlow 2s ease-in-out infinite;
    }
    
    @keyframes championGlow {
        0%, 100% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }
        50% { box-shadow: 0 0 60px rgba(255, 215, 0, 0.8); }
    }
    
    /* Responsive scaling text */
    @media (max-width: 1200px) {
        .bracket-header h1 { font-size: 1.2rem; }
        .round-column { min-width: 220px; }
        .team-name { max-width: 140px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="bracket-bg"></div>
<div class="bracket-viewport">
    <div class="bracket-header">
        <h1><i class="bi bi-trophy me-2 text-warning"></i>{{ tournament.name }}</h1>
        <div class="tournament-progress">
            {% set total = matches|length %}
            {% set completed = matches|selectattr('is_completed')|list|length %}
            <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: {{ (completed / total * 100) if total > 0 else 0 }}%"></div>
            </div>
            <span class="progress-text">{{ completed }}/{{ total }} matches</span>
        </div>
    </div>
    
    <div class="bracket-scale-wrapper" id="scaleWrapper">
        {% set rounds = matches|map(attribute='round_number')|list|unique|list %}
        <div class="bracket-container" id="bracketContainer">
            <svg class="bracket-connectors" id="connectorSvg"></svg>
            
            {% for round_num in rounds|sort %}
            <div class="round-column" data-round="{{ round_num }}">
                <div class="round-header {% if loop.last %}finals{% endif %}">
                    {% if loop.last %}
                        <i class="bi bi-trophy-fill me-2"></i>Finals
                    {% elif loop.index == loop.length - 1 %}
                        Semi-Finals
                    {% else %}
                        Round {{ round_num }}
                    {% endif %}
                </div>
                <div class="matches-wrapper">
                    {% set is_finals_round = (round_num == (rounds|sort|last)) %}
                    {% for match in matches if match.round_number == round_num %}
                    <div class="match-card {% if match.is_current %}current{% elif match.is_completed %}completed{% endif %} {% if is_finals_round and match.is_completed %}champion{% endif %}" 
                         data-match-id="{{ match.id }}"
                         data-round="{{ round_num }}"
                         data-next-match="{{ match.next_match_id or '' }}">
                        {% if match.is_current %}
                        <div class="live-badge">
                            <i class="bi bi-broadcast me-1"></i>LIVE NOW
                        </div>
                        {% endif %}
                        <div class="team-row {% if match.winner_id == match.team1_id %}winner{% endif %}">
                            <span class="team-name">
                                {% if match.winner_id == match.team1_id %}<i class="bi bi-trophy-fill trophy"></i>{% endif %}
                                {% if match.team1 %}{{ match.team1.name }}{% else %}<span class="tbd">TBD</span>{% endif %}
                            </span>
                            <span class="score">{{ match.team1_score }}</span>
                        </div>
                        <div class="team-row {% if match.winner_id == match.team2_id %}winner{% endif %}">
                            <span class="team-name">
                                {% if match.winner_id == match.team2_id %}<i class="bi bi-trophy-fill trophy"></i>{% endif %}
                                {% if match.team2 %}{{ match.team2.name }}{% else %}<span class="tbd">TBD</span>{% endif %}
                            </span>
                            <span class="score">{{ match.team2_score }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const socket = io();
    const tournamentId = {{ tournament.id }};
    
    // Auto-scaling logic
    function scaleBracket() {
        const wrapper = document.getElementById('scaleWrapper');
        const container = document.getElementById('bracketContainer');
        
        if (!wrapper || !container) return;
        
        // Reset transform to measure natural size
        container.style.transform = 'scale(1)';
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        // Calculate scale to fit - use nearly full space
        const scaleX = (wrapperRect.width - 20) / containerRect.width;
        const scaleY = (wrapperRect.height - 20) / containerRect.height;
        const scale = Math.min(scaleX, scaleY, 2.0); // Allow up to 2x for small brackets
        
        container.style.transform = `scale(${Math.max(0.5, scale)})`;
    }
    
    // Draw connector lines between matches
    function drawConnectors() {
        const svg = document.getElementById('connectorSvg');
        const container = document.getElementById('bracketContainer');
        
        if (!svg || !container) return;
        
        svg.innerHTML = '';
        
        const matches = container.querySelectorAll('.match-card[data-next-match]');
        
        matches.forEach(match => {
            const nextMatchId = match.dataset.nextMatch;
            if (!nextMatchId) return;
            
            const nextMatch = container.querySelector(`.match-card[data-match-id="${nextMatchId}"]`);
            if (!nextMatch) return;
            
            const matchRect = match.getBoundingClientRect();
            const nextRect = nextMatch.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // Calculate positions relative to container
            const x1 = matchRect.right - containerRect.left;
            const y1 = matchRect.top + matchRect.height / 2 - containerRect.top;
            const x2 = nextRect.left - containerRect.left;
            const y2 = nextRect.top + nextRect.height / 2 - containerRect.top;
            
            // Create curved path
            const midX = (x1 + x2) / 2;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}`);
            path.classList.add('connector-line');
            
            // Highlight if current match
            if (match.classList.contains('current')) {
                path.classList.add('active');
            }
            
            svg.appendChild(path);
        });
    }
    
    // Initialize
    window.addEventListener('load', () => {
        scaleBracket();
        setTimeout(drawConnectors, 100);
    });
    
    window.addEventListener('resize', () => {
        scaleBracket();
        setTimeout(drawConnectors, 100);
    });
    
    // Socket.IO events - update without full reload where possible
    socket.on('connect', function() {
        socket.emit('join_tournament', { tournament_id: tournamentId });
    });
    
    socket.on('score_update', function(data) {
        // Update score in place if possible
        const match = document.querySelector(`.match-card[data-match-id="${data.match_id}"]`);
        if (match) {
            const scores = match.querySelectorAll('.score');
            if (scores[0]) scores[0].textContent = data.team1_score;
            if (scores[1]) scores[1].textContent = data.team2_score;
        } else {
            location.reload();
        }
    });
    
    socket.on('match_complete', function(data) {
        // Reload to update bracket structure
        location.reload();
    });
    
    socket.on('current_match_changed', function(data) {
        location.reload();
    });
    
    // Auto-refresh every 60 seconds as backup
    setTimeout(function() {
        location.reload();
    }, 60000);
</script>
{% endblock %}
